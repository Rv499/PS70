<!DOCTYPE html>
<html lang="en">

<title>PS70: Intro to Digital Fabrication </title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="../style.css" rel="stylesheet">


<nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #130F1D; color: #EEE7E8;">
  <div style="align-items: center; justify-content: center;" class="container-fluid">
    <div class="flexrow">
      <h2 class="nav-title">PS70 // Intro to Digital Fabrication // Spring 24</h2>
    </div>
    <div class="navbar-nav">
      <h4><a class="nav-link" href="../index.html">Home</a></h4>
      <h4><a class="nav-link" href="../about.html">About</a></h4>
    </div>
  </div>
</nav>

<body>
<xmp style="display:none;">
<div class="textcontainer">
<p class="margin"></p>

<h3>Final Project: Heart Rate Driven Journal Prompt Wearable </h3>



<p class="margin"></p>
<p class="margin"></p>
<div class="flexrow">
  <a id="btn" href="finalproject.zip" download>Download the files used for my final project!
  </a>
</div>
<p class="margin"></p>

<h4>Phase 1: Brainstorming</h4>

<p class="margin"></p>
This project has had some changes since I have started the course. My orignal idea was to use EEG sensors to understand the emotional state of a person. These emotional states will be used to derive journal prompts. The follow on prompts would change based on the changed emotional state of the person. Unfortunately, this idea would be too complex from a data analysis standpoint. So I decided to go with a more simpler project. This new project would be a wearble device like a braclet that would were the device software analyzes the heart rate data to determine the user’s emotional or stress level (e.g., relaxed, anxious, excited). Based on this analysis, it generates journal prompts tailored to encourage reflection on the user’s current state. For example, a higher heart rates might trigger prompts related to managing stress or excitement, while lower rates could lead to prompts focused on gratitude or calmness.

<p class="margin"></p>
**Supplies**

- PPG Device
  - ~~MAX30100~~ or MAX30102
- ESP32 Board
- 3D Molded housing for ESP32 and PPG device
- Some type of small lcd interface to view prompts
- Battery

<p class="margin"></p>

**Software**: 


- Algorithm for interpreting heart rate data. MAX30102 library
- a database of journal prompts categorized by emotional state

<p class="margin"></p>


<p class="margin"></p>



<p class="margin"></p>
<div class="flexrow">
  <img src="MAX30102.jpeg" alt="a MAX30102 Board">
  <img src="Potential Diagram.jpeg" alt="a screenshot of possible 3D Model">
</div>
<p class="caption">Some early diagrams of device components.</p>


<p class="margin"></p>
<p class="margin"></p>
<h4>Phase 2: Prototyping</h4>

<p class="margin"></p>
The prototyping phase of this started when we learned about input devices. This helped me figure out the type of sensor I would want to use for the device. I narrowed it down to two sensors. The MAX3010 or the MAX30102. I decided to go with the MAX30102 due to the better accuracy of the sensor and a recent study that came out about the sensor located here: https://www.mdpi.com/2673-4591/16/1/9 .The sensor shape determines the foundation for the size and shape of the device.

<p class="margin"></p>
<p class="margin"></p>
<h4>Phase 3: Final Planning</h4>

<p class="margin"></p>
**Coming soon**

<p class="margin"></p>
<p class="margin"></p>
<h4>Phase 4: Assembly</h4>
Hardware Components
ESP32 Microcontroller: Chosen for its WiFi capabilities and compatibility with a variety of sensors.
Pulse Sensor: A simple heart rate sensor used to monitor the heart rate in real-time.
OLED Display: Used to provide immediate feedback and display the journal prompts generated based on the heart rate data.
Connecting Wires: For establishing connections between the ESP32, the pulse sensor, and the OLED display.
Software Components
Arduino IDE: Used for programming the ESP32.
Adafruit SSD1306 Library: For controlling the OLED display.
PulseSensor Playground Library: For interfacing with the pulse sensor.
WiFi and ChatGPT Libraries: To connect to the internet and interact with the ChatGPT API.
<p class="margin"></p>
Development Challenges and Solutions
Sensor Integration

Initially, I faced challenges with getting the pulse sensor to function correctly with the ESP32, an issue that did not occur with the Arduino platform. This was primarily due to the ESP32’s particular analog pin requirements, which I resolved by adjusting the sensor connection to an appropriate pin that supports analog inputs. I used a pin diagram to discover the potential inputs. I ended up settiling on pin 15

Incorporating ChatGPT

Integrating the ESP32 with the ChatGPT API initially led to multiple errors. After some troubleshooting, I discovered that these were linked to API access issues, which were resolved by opting into loading funds into my account, allowing uninterrupted access to ChatGPT services.

Display Issues

The OLED display initially did not operate as expected, which was later traced back to a faluty screen. Troubleshooting this took a lot longer than I expected since I didnt think having a bad screen was a potential issue. Replacing the defective unit promptly resolved this issue. Additionally, I adjusted the software to truncate ChatGPT responses to 100 characters, since I kept running into an issue with the journal prompts being too long on the OLED display

Trying for EEG

During the progression of this project, I explored the possibility of expanding the functionality by integrating EEG sensors instead of solely focusing on heart rate monitoring. I felth that there was better potential for EEG to provide deeper insights into cognitive states and emotional responses. However, the complexity of interpreting EEG data, coupled with the technical challenges of calibrating and accurately processing the signals, proved to be significant obstacles. Depsite different efforts the EEG integration did not materialize as hoped. One of the first issues I ran into was not having enough analogu inputs. Next there was an issue with noise on the few sensors i was able to connect. The idea was to try a few sensors and if i could get that to work I could then try and use multiple ESP 32 to add more sensors. Sadly I was not able to make sense of the noise in the data to make it useful. I decided to refocus on optimizing the heart rate sensor setup. I think this pivot taught me the importance of setting realistic scopes for project phases and recognizing when to streamline focus in response to technical feedback. Looking back I would have shfited focus back to the heart rate alot sooner.

Code
For the code I wanted to divide up the heart rate into several large sections. The idea was that these blocks of heart rate would be best able to determine someones mental state. Heart rate is not the best indication but its a good start for someone wanting to get into journaling. The code is set up that if someones heart rate goes about 120 the prompt will come back with breathing exercises to help the person calm down.

Conclusion
This project taught me many things about device planning and integration. Before this course I did not know anything about ESP32 or how to code them. It has been exciting to be able to expand each week on my knowledge on topoics. 

Future Directions
Going forward, I do plan to revisit the possibility of incorporating EEG sensors to enhance the device’s functionality to help offer a more comprehensive analysis of physiological and emotional states. Additionally, improving the user interface, possibly through more interactive components like touchscreens, could make the device more user-friendly and engaging.


<pre><code style="background-color: #2d2b33;">


#include <PulseSensorPlayground.h>     
  #include <WiFi.h>
#include <WiFiClientSecure.h>
#include <ArduinoJson.h>
#include <PulseSensorPlayground.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <ChatGPT.hpp>

// WiFi and OLED display settings
const char* ssid = "enter ssid";
const char* password = "enter password";
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C

// PulseSensor settings
const int PulseWire = 15;  // PulseSensor PURPLE WIRE connected to GPIO 15 (D15)
const int LED = 2;  // GPIO 2, commonly used for onboard LED in ESP32
int Threshold = 550;

// Global objects
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
PulseSensorPlayground pulseSensor;
WiFiClientSecure client;
ChatGPT<WiFiClientSecure> chat_gpt(&client, "v1", "insert api);

unsigned long lastUpdate = 0;  // Time since last display update
const long updateInterval = 200;  // Update interval in milliseconds

void setup() {
  Serial.begin(115200);
  display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS);
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);

  display.println("Connecting to WiFi...");
  display.display();
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
  }
  display.println("Connected!");
  display.display();
  client.setInsecure();

  pulseSensor.analogInput(PulseWire);
  pulseSensor.setThreshold(Threshold);
  if (!pulseSensor.begin()) {
    display.println("Failed to start pulse sensor");
    display.display();
    while (1);
  }
}

void loop() {
  if (pulseSensor.sawStartOfBeat()) {
    int heartRate = pulseSensor.getBeatsPerMinute();

    if (millis() - lastUpdate > updateInterval) {
      display.clearDisplay();
      display.setCursor(0, 0);
      display.print("Heart Rate: ");
      display.print(heartRate);
      display.println(" BPM");
      display.display();
      lastUpdate = millis();

      String prompt;
      if (heartRate < 60) {
        prompt = "Generate a calming journal prompt based on low heart rate.";
      } else if (heartRate >= 60 && heartRate < 80) {
        prompt = "Create a reflective journal prompt for a heart rate in a relaxed state.";
      } else if (heartRate >= 80 && heartRate < 100) {
        prompt = "Generate a journal prompt for moderate activity and stress levels.";
      } else if (heartRate >= 100 && heartRate < 120) {
        prompt = "Develop a prompt to explore feelings during increased physical or emotional stress.";
      } else {
        prompt = "Provide breathing exercises to help reduce heart rate and stress.";
      }

      String response;
      if (chat_gpt.simple_message("gpt-3.5-turbo-0301", "user", prompt, response)) {
        if (response.length() > 110) {
          response = response.substring(0, 110);  // Truncate to 110 characters
        }
        display.clearDisplay();
        display.setCursor(0, 0);
        display.println(response);
        display.display();
      } else {
        display.clearDisplay();
        display.setCursor(0, 0);
        display.println("Failed to get response:");
        display.println(response);
        display.display();
      }
    }
  }
}





</code></pre>

<p class="margin">   </p>
<div class="flexrow">
  <img src="./IMG_1679.heic">
</div>
<p class="caption">Wiring</p>
  </p>

<p class="margin">   </p>
<div class="flexrow">
  <img src="./IMG_1680.heic">
</div>
<p class="caption">Wiring</p>
  </p>

  <p class="margin">   </p>
<div class="flexrow">
  <img src="./IMG_1681.heic">
</div>
<p class="caption">Wiring</p>
  </p>

  <p class="margin">   </p>
<div class="flexrow">
  <img src="./IMG_1682.heic">
</div>
<p class="caption">Wiring</p>
  </p>

<p class="margin">   </p>
<div class="flexrow">
  <video controls>
    <source src="./IMG_1683.mov" type="video/mp4">
  </video>
  </div>

</div>
</xmp>
</body>

<script src="../strapdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" ></script>

</html>